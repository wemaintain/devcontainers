name: Test feature

on:
  workflow_call:
    inputs:
      feature: { type: string, required: true }

jobs:
  test:
    name: Test

    permissions:
      contents: read
      packages: read

    strategy:
      matrix:
        os:
          - { name: ubuntu-24.04, arch: amd64 }
          - { name: ubuntu-24.04-arm, arch: arm64 }

    runs-on: ${{ matrix.os.name }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ vars.CONTAINER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Test feature
        env:
          FEATURE: ${{ inputs.feature }}
        run: |
          for _FEATURE in features/src/*; do
            cp \
              ./features/lib/install.sh \
              "$_FEATURE/dev-container-features-install-lib"
          done
          npx -y @devcontainers/cli features test \
            --project-folder ./features \
            --skip-autogenerated \
            --skip-duplicated \
            --features "$FEATURE"
